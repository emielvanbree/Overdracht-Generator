<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Pleyade Overdrachten Generator</title>
  <style>
    body { font-family: 'Open Sans', Arial, sans-serif; background:#FBEEED; color:#4A2F3E; margin:0; padding:0; }
    header { background:#8B4C69; color:white; padding:1rem; text-align:center; box-shadow:0 4px 6px rgba(0,0,0,0.2); }
    h1 { margin:0; font-weight:600; }
    main { max-width:900px; margin:2rem auto; background:white; border:1px solid #E0C9C5; border-radius:1rem; padding:2rem; box-shadow:0 2px 6px rgba(0,0,0,0.1);} 
    label { display:block; margin-top:1rem; font-weight:600; }
    input, textarea { width:100%; padding:0.5rem; margin-top:0.25rem; margin-bottom:0.75rem; border:1px solid #E0C9C5; border-radius:0.5rem; font-family:inherit; }
    .btnrow { display:flex; gap:0.5rem; align-items:center; margin-bottom:1rem; }
    .status { font-size:0.9rem; font-style:italic; color:#5C2F42; }
    button { padding:0.5rem 1rem; border:none; border-radius:2rem; cursor:pointer; font-weight:600; }
    .primary { background:#8B4C69; color:white; }
    .primary:hover { background:#5C2F42; }
    .secondary { background:#F4D8D4; color:#5C2F42; }
    .secondary:hover { background:#8B4C69; color:white; }
    #globalStatus { margin-top:1rem; font-style:italic; color:#5C2F42; white-space:pre-line; }
    footer { text-align:center; padding:1rem; background:#F4D8D4; color:#5C2F42; }
  </style>
</head>
<body>
  <header>
    <h1>Pleyade Overdrachten Generator</h1>
  </header>
  <main>
    <form id="overdrachtForm">
      <h2>Sectie 1 – Clientinformatie</h2>
      <label>Volledige naam<input type="text" id="clientNaam"></label>
      <div class="btnrow"><button type="button" onclick="startRecording('clientNaam')" class="secondary">🎙️ Opnemen</button><button type="button" onclick="stopRecording('clientNaam')" class="secondary">⏹️ Stop</button><span id="status-clientNaam" class="status">Idle</span></div>
      <label>Geboortedatum<input type="date" id="clientDOB"></label>

      <h2>Sectie 2 – Medische voorgeschiedenis</h2>
      <label>(Hoofd)diagnose(s) en behandelreden<textarea id="diagnose" rows="3"></textarea></label>
      <div class="btnrow"><button type="button" onclick="startRecording('diagnose')" class="secondary">🎙️ Opnemen</button><button type="button" onclick="stopRecording('diagnose')" class="secondary">⏹️ Stop</button><span id="status-diagnose" class="status">Idle</span></div>
      <label>Relevante comorbiditeit<textarea id="comorbiditeit" rows="3"></textarea></label>
      <div class="btnrow"><button type="button" onclick="startRecording('comorbiditeit')" class="secondary">🎙️ Opnemen</button><button type="button" onclick="stopRecording('comorbiditeit')" class="secondary">⏹️ Stop</button><span id="status-comorbiditeit" class="status">Idle</span></div>
      <label>Relevante operaties of behandelingen<textarea id="operaties" rows="3"></textarea></label>
      <div class="btnrow"><button type="button" onclick="startRecording('operaties')" class="secondary">🎙️ Opnemen</button><button type="button" onclick="stopRecording('operaties')" class="secondary">⏹️ Stop</button><span id="status-operaties" class="status">Idle</span></div>

      <h2>Sectie 3 – Revalidatieverloop en huidige status</h2>
      <label>Datum opname<input type="date" id="datumOpname"></label>
      <label>Datum ontslag<input type="date" id="datumOntslag"></label>
      <label>Behandelfrequentie en -duur<textarea id="frequentie" rows="2"></textarea></label>
      <div class="btnrow"><button type="button" onclick="startRecording('frequentie')" class="secondary">🎙️ Opnemen</button><button type="button" onclick="stopRecording('frequentie')" class="secondary">⏹️ Stop</button><span id="status-frequentie" class="status">Idle</span></div>
      <label>Specifieke revalidatiedoelen<textarea id="doelen" rows="2"></textarea></label>
      <div class="btnrow"><button type="button" onclick="startRecording('doelen')" class="secondary">🎙️ Opnemen</button><button type="button" onclick="stopRecording('doelen')" class="secondary">⏹️ Stop</button><span id="status-doelen" class="status">Idle</span></div>
      <label>Mobiliteit en gangpatroon<textarea id="mobiliteit" rows="2"></textarea></label>
      <div class="btnrow"><button type="button" onclick="startRecording('mobiliteit')" class="secondary">🎙️ Opnemen</button><button type="button" onclick="stopRecording('mobiliteit')" class="secondary">⏹️ Stop</button><span id="status-mobiliteit" class="status">Idle</span></div>

      <h2>Sectie 4 – Behandelplan voor de eerstelijnszorg</h2>
      <label>Aanbevolen behandeldoelen<textarea id="behandelDoelen" rows="3"></textarea></label>
      <div class="btnrow"><button type="button" onclick="startRecording('behandelDoelen')" class="secondary">🎙️ Opnemen</button><button type="button" onclick="stopRecording('behandelDoelen')" class="secondary">⏹️ Stop</button><span id="status-behandelDoelen" class="status">Idle</span></div>
      <label>Verdere opmerkingen<textarea id="opmerkingen" rows="3"></textarea></label>
      <div class="btnrow"><button type="button" onclick="startRecording('opmerkingen')" class="secondary">🎙️ Opnemen</button><button type="button" onclick="stopRecording('opmerkingen')" class="secondary">⏹️ Stop</button><span id="status-opmerkingen" class="status">Idle</span></div>

      <h2>Sectie 5 – Overdracht door</h2>
      <label>Naam en contactgegevens revalidatietherapeut<textarea id="therapeut" rows="2"></textarea></label>
      <div class="btnrow"><button type="button" onclick="startRecording('therapeut')" class="secondary">🎙️ Opnemen</button><button type="button" onclick="stopRecording('therapeut')" class="secondary">⏹️ Stop</button><span id="status-therapeut" class="status">Idle</span></div>

      <button type="button" onclick="generateOverdracht()" class="primary">📄 Genereer overdracht</button>
    </form>
    <div id="globalStatus"></div>
  </main>
  <footer>NightOwl Logic © 2025</footer>

<script>
const ASSEMBLY_KEY = "99bfc1680f0b4cca9e7d3ce2495eb058";

let mediaRecorder;
let audioChunks=[];
let currentField=null;

function setFieldStatus(fieldId, status){
  const el = document.getElementById("status-"+fieldId);
  if(el) el.innerText = status;
}

function startRecording(fieldId){
  currentField = fieldId;
  navigator.mediaDevices.getUserMedia({ audio: true })
    .then(stream => {
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];
      mediaRecorder.ondataavailable = event => {
        audioChunks.push(event.data);
      };
      mediaRecorder.onstop = () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        transcribeAudio(audioBlob, currentField);
      };
      mediaRecorder.start();
      setFieldStatus(fieldId, "Opname bezig...");
    });
}

function stopRecording(fieldId){
  if(mediaRecorder && mediaRecorder.state!=='inactive'){
    mediaRecorder.stop();
    setFieldStatus(fieldId, "Opname gestopt, verwerken...");
  }
}

async function transcribeAudio(blob, fieldId){
  try {
    const uploadRes = await fetch("https://api.assemblyai.com/v2/upload", {
      method: "POST",
      headers: { authorization: ASSEMBLY_KEY },
      body: blob
    });
    const { upload_url } = await uploadRes.json();

    const transRes = await fetch("https://api.assemblyai.com/v2/transcript", {
      method: "POST",
      headers: { "authorization": ASSEMBLY_KEY, "content-type": "application/json" },
      body: JSON.stringify({
        audio_url: upload_url,
        language_code: "nl",
        language_detection: false,
        punctuate: true,
        format_text: true
      })
    });
    const { id } = await transRes.json();

    let transcript;
    while(true){
      const statusRes = await fetch(`https://api.assemblyai.com/v2/transcript/${id}`, { headers: { authorization: ASSEMBLY_KEY }});
      const data = await statusRes.json();
      if(data.status === "completed"){ transcript = data.text; break; }
      if(data.status === "error"){ throw new Error(data.error); }
      await new Promise(r=>setTimeout(r, 2000));
    }

    document.getElementById(fieldId).value = transcript;
    setFieldStatus(fieldId, "Transcriptie toegevoegd");
  } catch(e){
    setFieldStatus(fieldId, "Fout bij transcriptie");
    console.error(e);
  }
}

function buildHtmlDoc(){
  const ts=new Date().toLocaleString();
  const naam=document.getElementById("clientNaam")?.value||"";
  const dob=document.getElementById("clientDOB")?.value||"";
  const diagnose=document.getElementById("diagnose")?.value||"";
  const comorbiditeit=document.getElementById("comorbiditeit")?.value||"";
  const operaties=document.getElementById("operaties")?.value||"";
  const datumOpname=document.getElementById("datumOpname")?.value||"";
  const datumOntslag=document.getElementById("datumOntslag")?.value||"";
  const frequentie=document.getElementById("frequentie")?.value||"";
  const doelen=document.getElementById("doelen")?.value||"";
  const mobiliteit=document.getElementById("mobiliteit")?.value||"";
  const behandelDoelen=document.getElementById("behandelDoelen")?.value||"";
  const opmerkingen=document.getElementById("opmerkingen")?.value||"";
  const therapeut=document.getElementById("therapeut")?.value||"";

  const styles = `<style>
    body { font-family: 'Open Sans', Arial, sans-serif; color:#4A2F3E; }
    h1,h2,h3,h4 { font-weight:600; color:#5C2F42; }
    h1 { font-size:22pt; background:#8B4C69; color:#fff; padding:10px; border-radius:8px; box-shadow:0 3px 6px rgba(0,0,0,0.2); }
    h2 { font-size:16pt; margin-top:1em; border-bottom:2px solid #E0C9C5; padding-bottom:4px; }
    p { font-size:11pt; margin:0.5em 0; }
  </style>`;

  return `<!DOCTYPE html><html><head><meta charset="utf-8">${styles}</head><body>
    <h1>Pleyade Overdracht</h1>
    <p><b>Gegenereerd op:</b> ${ts}</p>
    <h2>Sectie 1 – Clientinformatie</h2>
    <p><b>Naam:</b> ${naam}<br><b>Geboortedatum:</b> ${dob}</p>
    <h2>Sectie 2 – Medische voorgeschiedenis</h2>
    <p><b>Diagnose(s) en behandelreden:</b> ${diagnose}<br><b>Comorbiditeit:</b> ${comorbiditeit}<br><b>Operaties/behandelingen:</b> ${operaties}</p>
    <h2>Sectie 3 – Revalidatieverloop en huidige status</h2>
    <p><b>Opname:</b> ${datumOpname}<br><b>Ontslag:</b> ${datumOntslag}<br><b>Frequentie en duur:</b> ${frequentie}<br><b>Doelen:</b> ${doelen}<br><b>Mobiliteit:</b> ${mobiliteit}</p>
    <h2>Sectie 4 – Behandelplan eerstelijnszorg</h2>
    <p><b>Behandeldoelen:</b> ${behandelDoelen}<br><b>Opmerkingen:</b> ${opmerkingen}</p>
    <h2>Sectie 5 – Overdracht door</h2>
    <p>${therapeut}</p>
  </body></html>`;
}

async function generateOverdracht(){
  document.getElementById("globalStatus").innerText = "Document genereren...";
  try {
    const html = buildHtmlDoc();
    const blob = new Blob([html], { type: 'application/msword' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Overdracht_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.doc`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    document.getElementById("globalStatus").innerText = "Download afgerond.";
  } catch(e){
    console.error("FOUT bij generateOverdracht:", e);
    document.getElementById("globalStatus").innerText = "Fout: "+e.message;
  }
}
</script>
</body>
</html>
